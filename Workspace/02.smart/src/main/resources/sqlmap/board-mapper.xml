<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="board">

	<!-- 선택한 방명록 글 삭제 -->
	<delete id="delete">
		delete from board where id = #{id}
	</delete>

	<!-- 선택한 첨부파일정보 조회 -->
	<select id="fileInfo" resultType="smart.board.FileVO">
		select * from board_file where
		id =#{id}
	</select>

	<!-- 선택한 방명록의 첨부파일 이름 조회 -->
	<select id="fileList" resultType="smart.board.FileVO">
		select * from board_file where
		board_id = #{id}
	</select>

	<!-- 조회수 증가 처리 -->
	<update id="test">
		update board set readcnt = readcnt+1 where id = #{id}
	</update>

	<!-- 선택한 방명록 글 조회 -->
	<select id="info" resultType="smart.board.BoardVO">
		select b.*, name
		from board b inner
		join member m on writer = userid
		where id = #{id}
	</select>

	<!-- 검색조건 -->
	<sql id="searchWhere">
		<choose>
			<!-- 전체 -->
			<when test=" search == 's1' ">where title like '%'||#{keyword}||'%' or content like
				'%'||#{keyword}||'%' or writer in (select userid from member where
				name like '%'||#{keyword}||'%')</when>
			<!-- 제목 -->
			<when test=" search == 's2' ">
				where title like '%'||#{keyword}||'%'
			</when>
			<!-- 내용 -->
			<when test=" search == 's3' ">
				where content like '%'||#{keyword}||'%'
			</when>
			<!-- 작성자 -->
			<when test=" search == 's4' ">
				where writer in (select userid from member where
				name
				like '%'||#{keyword}||'%')
			</when>
			<!-- 제목 + 내용 -->
			<when test=" search == 's5' ">
				where title like '%'||#{keyword}||'%'
				or content like
				'%'||#{keyword}||'%'
			</when>
		</choose>
	</sql>
	<insert id="register">
		<selectKey order="AFTER" resultType="integer"
			keyProperty="id">
			select seq_board.currval from dual
		</selectKey>
		<!-- 방명록에 딸린 첨부파일 정보 저장 -->
		insert into board (title, content, writer) values (#{title},
		#{content}, #{writer})
	</insert>

	<insert id="fileRegister">
		<foreach collection="fileList" item="file" open="insert all"
			separator=" " close="select * from dual">
			into
			board_file (board_id, filename,
			filepath)
			values(#{id},
			#{file.filename},#{file.filepath})
		</foreach>
	</insert>

	<!-- 방명록 글 총 건수 조회 -->
	<select id="totalList" resultType="integer">
		select count(*) from board
		<include refid="searchWhere" />
	</select>

	<select id="list" resultType="smart.board.BoardVO">
		select (select count(*) from
		board_file where b.id = board_id) filecnt,
		b.* from
		(select
		row_number()
		over(order by
		id) no, b.*, name from board b
		inner
		join
		member m on
		b.writer = m.userid
		<include refid="searchWhere" />
		) b
		where no between #{beginList} and
		#{endList}
		order by no desc

	</select>



</mapper>